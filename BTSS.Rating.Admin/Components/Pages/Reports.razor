@page "/reports"
@using BTSS.Rating.Infrastructure.Persistence
@using BTSS.Rating.Infrastructure.Persistence.Entities
@using Microsoft.EntityFrameworkCore
@inject RatingDbContext Db

<h3>Reports</h3>

<RadzenRow Gap="1rem">
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenText Text="RateQuotes (latest 200)" TextStyle="TextStyle.Subtitle1" />
            <RadzenDataGrid Data="@quotes" TItem="RateQuote" AllowPaging="true" PageSize="15" RowSelect="@OnQuoteSelected">
                <Columns>
                    <RadzenDataGridColumn TItem="RateQuote" Property="RateQuoteId" Title="Id" Width="80px" />
                    <RadzenDataGridColumn TItem="RateQuote" Title="RequestId">
                        <Template Context="q">@q.RequestId.ToString("N")</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="RateQuote" Property="Mode" Title="Mode" Width="70px" />
                    <RadzenDataGridColumn TItem="RateQuote" Property="RateDate" Title="RateDate" />
                    <RadzenDataGridColumn TItem="RateQuote" Property="CreatedAt" Title="Created" />
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenText Text="Results" TextStyle="TextStyle.Subtitle1" />
            <RadzenDataGrid Data="@results" TItem="RateQuoteResult" AllowPaging="true" PageSize="15" RowSelect="@OnResultSelected">
                <Columns>
                    <RadzenDataGridColumn TItem="RateQuoteResult" Property="RateQuoteResultId" Title="ResultId" Width="95px" />
                    <RadzenDataGridColumn TItem="RateQuoteResult" Property="Rank" Title="Rank" Width="60px" />
                    <RadzenDataGridColumn TItem="RateQuoteResult" Property="TotalAmount" Title="Total" />
                    <RadzenDataGridColumn TItem="RateQuoteResult" Property="TransitDays" Title="Transit" Width="70px" />
                    <RadzenDataGridColumn TItem="RateQuoteResult" Property="CreatedAt" Title="Created" />
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenText Text="Charge Lines" TextStyle="TextStyle.Subtitle1" />
            <RadzenDataGrid Data="@charges" TItem="RateQuoteChargeLine" AllowPaging="true" PageSize="15">
                <Columns>
                    <RadzenDataGridColumn TItem="RateQuoteChargeLine" Property="SequenceNo" Title="#" Width="50px" />
                    <RadzenDataGridColumn TItem="RateQuoteChargeLine" Property="CanonicalChargeType" Title="Type" />
                    <RadzenDataGridColumn TItem="RateQuoteChargeLine" Property="Description" Title="Description" />
                    <RadzenDataGridColumn TItem="RateQuoteChargeLine" Property="Amount" Title="Amount" />
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<RateQuote> quotes = new();
    private List<RateQuoteResult> results = new();
    private List<RateQuoteChargeLine> charges = new();

    protected override async Task OnInitializedAsync()
    {
        quotes = await Db.RateQuotes.OrderByDescending(q => q.CreatedAt).Take(200).ToListAsync();
    }

    private async Task OnQuoteSelected(RateQuote q)
    {
        results = await Db.RateQuoteResults.Where(r => r.RateQuoteId == q.RateQuoteId)
            .OrderBy(r => r.Rank)
            .ToListAsync();
        charges = new();
    }

    private async Task OnResultSelected(RateQuoteResult r)
    {
        charges = await Db.RateQuoteChargeLines.Where(c => c.RateQuoteResultId == r.RateQuoteResultId)
            .OrderBy(c => c.SequenceNo)
            .ToListAsync();
    }
}
