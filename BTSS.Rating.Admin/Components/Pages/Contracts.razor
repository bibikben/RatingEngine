@page "/contracts"
@using BTSS.Rating.Infrastructure.Persistence
@using BTSS.Rating.Infrastructure.Persistence.Entities
@using Microsoft.EntityFrameworkCore
@inject RatingDbContext Db
@inject BTSS.Rating.Admin.Services.RatingApiClient Api
@inject NotificationService Notifications

<h3>Contracts</h3>

<RadzenRow Gap="1rem">
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <RadzenText Text="Contracts" TextStyle="TextStyle.Subtitle1" />
            <RadzenDataGrid @ref="contractsGrid" Data="@contracts" TItem="Contract"
                            AllowFiltering="true" AllowPaging="true" PageSize="15"
                            AllowSorting="true" RowSelect="@OnContractSelected">
                <Columns>
                    <RadzenDataGridColumn TItem="Contract" Property="ContractId" Title="Id" Width="80px" />
                    <RadzenDataGridColumn TItem="Contract" Property="Name" Title="Name" />
                    <RadzenDataGridColumn TItem="Contract" Property="Mode" Title="Mode" Width="70px" />
                    <RadzenDataGridColumn TItem="Contract" Property="Status" Title="Status" Width="90px" />
                    <RadzenDataGridColumn TItem="Contract" Property="IsActive" Title="Active" Width="80px" />
                    <RadzenDataGridColumn TItem="Contract" Property="CreatedAt" Title="Created" />
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenText Text="Contract Versions" TextStyle="TextStyle.Subtitle1" />
                @if (selectedContract is not null)
                {
                    <RadzenText Text=@$"ContractId={selectedContract.ContractId}" />
                }
            </RadzenStack>

            <RadzenDataGrid @ref="versionsGrid" Data="@versions" TItem="ContractVersion"
                            AllowFiltering="true" AllowPaging="true" PageSize="15"
                            AllowSorting="true">
                <Columns>
                    <RadzenDataGridColumn TItem="ContractVersion" Property="ContractVersionId" Title="VersionId" Width="110px" />
                    <RadzenDataGridColumn TItem="ContractVersion" Property="VersionNo" Title="Ver#" Width="70px" />
                    <RadzenDataGridColumn TItem="ContractVersion" Title="Status" Width="120px">
                        <Template Context="v">
                            @StatusBadge(v.PublishStatus)
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ContractVersion" Property="EffectiveStart" Title="Eff Start" />
                    <RadzenDataGridColumn TItem="ContractVersion" Property="EffectiveEnd" Title="Eff End" />
                    <RadzenDataGridColumn TItem="ContractVersion" Property="PublishedAt" Title="PublishedAt" />
                    <RadzenDataGridColumn TItem="ContractVersion" Title="Actions" Width="140px">
                        <Template Context="v">
                            <RadzenButton Text="Publish"
                                          Disabled="@IsPublished(v)"
                                          Size="ButtonSize.Small"
                                          Icon="publish"
                                          Click="@(async () => await Publish(v))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            @if (!string.IsNullOrWhiteSpace(publishError))
            {
                <RadzenAlert Severity="AlertSeverity.Danger" class="rz-mt-2">@publishError</RadzenAlert>
            }
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private RadzenDataGrid<Contract>? contractsGrid;
    private RadzenDataGrid<ContractVersion>? versionsGrid;

    private List<Contract> contracts = new();
    private List<ContractVersion> versions = new();
    private Contract? selectedContract;
    private string? publishError;

    protected override async Task OnInitializedAsync()
    {
        await LoadContracts();
    }

    private async Task LoadContracts()
    {
        contracts = await Db.Contracts.OrderByDescending(c => c.CreatedAt).Take(500).ToListAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnContractSelected(Contract c)
    {
        selectedContract = c;
        publishError = null;
        versions = await Db.ContractVersions
            .Where(v => v.ContractId == c.ContractId)
            .OrderByDescending(v => v.ContractVersionId)
            .ToListAsync();
    }

    private static bool IsPublished(ContractVersion v) =>
        string.Equals(v.PublishStatus, "Published", StringComparison.OrdinalIgnoreCase);

    private RenderFragment StatusBadge(string? status) => builder =>
    {
        var s = string.IsNullOrWhiteSpace(status) ? "Draft" : status;
        var severity = s.Equals("Published", StringComparison.OrdinalIgnoreCase)
            ? AlertSeverity.Success
            : s.Equals("Retired", StringComparison.OrdinalIgnoreCase)
                ? AlertSeverity.Info
                : AlertSeverity.Warning;

        builder.OpenComponent<RadzenBadge>(0);
        builder.AddAttribute(1, "Text", s);
        builder.AddAttribute(2, "Severity", severity);
        builder.CloseComponent();
    };

    private async Task Publish(ContractVersion v)
    {
        publishError = null;
        try
        {
            await Api.PublishContractVersionAsync(v.ContractVersionId, userId: "admin", note: "Published via Admin UI");
            Notifications.Notify(NotificationSeverity.Success, "Published", $"ContractVersion {v.ContractVersionId} published.");
            // refresh
            if (selectedContract is not null)
                await OnContractSelected(selectedContract);
        }
        catch (Exception ex)
        {
            publishError = ex.Message;
            Notifications.Notify(NotificationSeverity.Error, "Publish failed", ex.Message);
        }
    }
}
